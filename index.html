<!DOCTYPE html>
<html>
<head>
	<title>Pente</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="/wgo.js"></script>

	<style>
		body {
			margin-top:30px;
		}

		#lobbyArea {
			display:none;
		}

		#gameArea {
			display:none;
		}
	</style>
</head>

<body>
	<div class="container">
		<div id="loginArea" class="row">
			<div class="col-md-8">
				<form id="loginForm">
					<div class="form-group">
						<label>Enter player name</label>
						<input class="form-control" id="username" />
						<br />
						<input type="submit" class="btn btn-primary" value="Enter" />
					</div>
				</form>
			</div>
		</div>

		<div id="lobbyArea" class="row">
			<div id="users">
				Waiting for opponent...
			</div>
		</div>

		<div id="gameArea" class="row">
<!-- 			<div id="message">
			</div> -->

			<div id="board">
			</div>

			<div id="opponent">
			</div>
		</div>
	</div>

	<script>
		$(function() {
			var socket = io.connect();

			var $loginArea = $('#loginArea');
			var $loginForm = $('#loginForm');
			var $lobbyArea = $('#lobbyArea');
			var $gameArea = $('#gameArea');
			//var $message = $('#message');
			var $username = $('#username');
			var $users = $('#users');
			//var $board = $('#board');
			var $opponent = $('#opponent');

			var opponent = '';
			var pieceColor = '';
			var gameBoard;

			$loginForm.submit(function(e) {
				e.preventDefault();

				// push username to server
				username = $username.val();
				if (username === '') username = 'Anonymous';
				socket.emit('join lobby', username);
				$username.val('');

				// move from login screen to game screen
				$loginArea.css('display', 'none');
				$lobbyArea.css('display', 'block');
			});

			// Got paired with another player in the lobby
			socket.on('found match', function(data) {
				// Switch to the game area page
				$lobbyArea.css('display', 'none');
				$gameArea.css('display', 'block');

				opponent = data.msg;
				$opponent.append('<p>Playing against: '+opponent+'</p>');
				//$message.append('Paired with user '+opponent+'\n');

				pieceColor = data.start ? "white" : "black";

				setupGameBoard();
			});

			// Called when the opponent leaves the game
			// TODO notify the player
			socket.on('opponent left', function(data) {
				//$message.empty();
				//$message.append(opponent + ' has left the game');
			});

			// Returns the indices of the position where the click was performed
			// Adjusts offset relative to the board's position on the page
			// and scales the coordinates to be (0, board.size) to conform to
			// WGo.js using array indices rather than float coordinates
			function getClickIndices(canvas, board, absX, absY) {
				var rect = canvas.getBoundingClientRect();

				var totalWidth = 600;
				var boardWidth = .784 * totalWidth;
				var boardBorder = .108 * totalWidth;

				var relX = absX - boardBorder - rect.left;
				var relY = absY - boardBorder - rect.top;

				var x = Math.round((relX / boardWidth) * board.size);
				var y = Math.round((relY / boardWidth) * board.size);

				console.log('border: '+boardBorder);
				console.log('Absolute: '+absX+' '+absY);
				console.log('Relative: '+relX+' '+relY);

				return [x,y];
			}

			// Returns how far offset the canvas is on the page.
			// This corrects where the pente piece shows up based 
			// on the user click because they get placed incorrectly when
			// there are margins around the canvas element.
			function getOffsetIndices() {
				var canvas = document.getElementById('board');
				var rect = canvas.getBoundingClientRect();


			}

			function setupGameBoard() {
				//var containerDiv = document.getElementById('board');

				// Initializes the game board
				gameBoard = new WGo.Board(document.getElementById('board'), {
					width: 600,
					size: 19,
				});
				//console.log('Initial width: '+gameBoard.width);

				// Handles user clicks and places a piece down
				//document.getElementById('board').addEventListener("click", function(ev) {
					//var coords = getClickIndices(document.getElementById('board'), gameBoard, ev.clientX, ev.clientY);
					//console.log(coords);

				gameBoard.addEventListener("click", function(x, y) {

					socket.emit('place piece', {x: x, y: y, color: pieceColor});
				});
			}

			// Called when a piece has been placed down (by this user or the opponent)
			// and the server has validated this move
			socket.on('piece placed', function(data) {
				var x = data.x;
				var y = data.y;
				var color = data.color == 'black' ? WGo.B : WGo.W;

				gameBoard.addObject({
					x: x,
					y: y,
					c: color
				});
			});
		});
	</script>
</body>
</html>